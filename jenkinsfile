properties([parameters([choice(choices: ['Patch','Minor','Major'], description: 'Third stage meassage', name: 'ImageTag' )])])
pipeline{
  agent any
   environment {
    DOCKERHUB_CREDENTIALS=credentials('dockerhub')
    def patch = ''
    def minor = ''
    def major = ''
    def new_version = ''
  }
  stages{
        stage('Pull version'){
            steps{
              script{
       def version = readFile('VERSION')
                     echo "${version}"

                     if("${ImageTag}"=="Patch"){
                      echo "This is patch version"
		      def versions = version.split('\\.')
		      def last = versions[2]
		      last = last.toInteger() + 1;
		      new_version = versions[0] + '.' + versions[1]+'.'+"$last"
		      echo "$new_version"
		     
		      
                     }else if("${ImageTag}"=="Minor"){
		      def versions = version.split('\\.')
		      def mid = versions[1]
		      mid = mid.toInteger() + 1;
		      new_version = versions[0] + '.' + "$mid"+'.'+0
		      echo "$new_version"
		      

                      echo "This is minor version"
                     }else{
                      echo "This is major version"
		      def versions = version.split('\\.')
		      def first = versions[0]
		      first = first.toInteger() + 1;
		      new_version = "$first" + '.' + 0 +'.' + 0
		      echo "$new_version"
		      
		      
                     }
                }    new_version
  
           }
        }
	
	
	
	stage('Build') {

			steps {
				script{
					switch("${ImageTag}") {
  						case "Patch":
   						 	echo "This is patch build block"
    						sh "docker build . -t nadeem90/test-imagetage:$patch"
    						break
  						case "Minor":
   							echo "this is minor build block"
   						 	sh "docker build . -t nadeem90/test-imagetage:$minor"
   						 	break
  						case "Major":
    						echo "This is major build block"
   							sh "docker build . -t nadeem90/test-imagetage:$major"
    						break
						}
					
				      	}	
              			}
			}
			
			

	stage('Docker Login, Docker Push') {

			steps {
				script{
				docker.withRegistry('', 'dockerhub') {
					switch("${ImageTag}") {
  						case "Patch":
   						 echo "This is patch block"
    						//sh "docker push nadeem90/test-imagetage:'$patch'"
    						break
  						case "Minor":
   						echo "this is minor block"
    						//sh "docker push nadeem90/test-imagetage:'$minor'"
   						 break
  						case "Major":
    						echo "This is major block"
   						 //sh "docker push nadeem90/test-imagetage:'$major'"
    						break
						}
						
					}	
					
				      }	
              
			}
		}
	
	
     }
  } 
